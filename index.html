<html>

<head>

<title>Gitgraph</title>

<style>
.center {
  display: flex;
  justify-content: center;
  align-items: center;
}

.padded {
  padding: 1rem;
}

#floating-top {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
}

#auth-token-input {
  border-radius: 2rem;
  border-color: #eFf4f5;
  border-style: solid;
  background: #ecf0f1;

  box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
  transition: all 0.3s cubic-bezier(.25,.8,.25,1);
}

#auth-token-input:focus {
  outline: none;
  border-color: #fff;

  box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
}

#container {
  width: 100vw;
  height: 100vh;
  display: block;
}
</style>

</head>

<body>

<div id="floating-top">
  <div class="center padded">
    <form onsubmit="return window.go()">
      <input class="padded"
            name="auth-token"
            type="password"
            id="auth-token-input"
            placeholder="Auth Token"></input>
    </form>
  </div>
</div>

<div id="container"></div>

</body>

<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/layout-base/layout-base.js"></script>
<script src="https://unpkg.com/cose-base/cose-base.js"></script>
<script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>

<script type="module">
import { Octokit } from 'https://cdn.pika.dev/@octokit/rest';

window.go = () => {
  const auth = document.getElementById('auth-token-input').value;

  const octokit = new Octokit({
    auth: auth,
    userAgent: "Gitgraph",
    log: {
      debug: () => {},
      info: () => {},
      warn: console.log,
      error: console.log
    },
    request: {
      agent: undefined,
      fetch: undefined,
      timeout: 0
    }
  });

  const graph = cytoscape({
    container: document.getElementById('container'),

    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(id)'
        }
      },

      {
        selector: 'edge',
        style: {
          'width': 3,
          'line-color': '#444',
          'target-arrow-color': '#444',
          'target-arrow-shape': 'triangle',
          'curve-style': 'straight'
        }
      }
    ]
  });

  graph.on('tap', 'node', (event) => {
    const node = event.target;
    const username = node.id();

    octokit.users
      .listFollowingForUser({
        username: username,
        per_page: 100
      })
      .then((response) => {
        for (let user of response.data) {
          if (!graph.nodes(`#${user.login}`).length) {
            graph.add({
              data: {
                id: user.login,
              }
            });
          }

          graph.add({
            data: {
              id: `${username} follows ${user.login}`,
              source: username,
              target: user.login
            }
          });

          const eles = graph.$(`#${user.login}`);
          eles.style('background-image', `url('${user.avatar_url}')`);
          eles.style('background-fit', 'cover');
          eles.style('height', '80');
          eles.style('width', '80');
        }

        graph
          .layout({
            name: 'fcose',
            quality: 'proof',
            idealEdgeLength: graph.$('*').length * 2
          })
          .run();
      });
  });

  octokit.users
    .getAuthenticated()
    .then((response) => {
      const user = response.data;

      graph.add({
        data: {
          id: user.login,
        }
      });

      const eles = graph.$(`#${user.login}`);
      eles.style('background-image', `url('${user.avatar_url}')`);
      eles.style('background-fit', 'cover');
      eles.style('height', '80');
      eles.style('width', '80');
    });

  document.getElementById('floating-top').remove();

  return false;
};
</script>

</html>
